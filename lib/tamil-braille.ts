// Tamil to Braille mapping
const TAMIL_BRAILLE_MAP: Record<string, number[][]> = {
  "அ": [[1]],
  "ஆ": [[3,4,5]],
  "இ": [[2,4]],
  "ஈ": [[3,5]],
  "உ": [[1,3,6]],
  "ஊ": [[1,2,5,6]],
  "எ": [[2,6]],
  "ஏ": [[1,5]],
  "ஐ": [[3,4]],
  "ஒ": [[1,3,4,6]],
  "ஓ": [[1,3,5]],
  "ஔ": [[2,4,6]],
  "ஃ": [[6]],
  "க": [[1,3]],
  "ங": [[3,4,6]],
  "ச": [[1,4]],
  "ஞ": [[2,5]],
  "ட": [[2,3,4,5,6]],
  "ண": [[3,4,5,6]],
  "த": [[2,3,4,5]],
  "ந": [[1,3,4,5]],
  "ப": [[1,2,3,4]],
  "ம": [[1,3,4]],
  "ய": [[1,3,4,5,6]],
  "ர": [[1,2,3,5]],
  "ல": [[1,2,3]],
  "வ": [[1,2,3,6]],
  "ழ": [[1,2,3,5,6]],
  "ற": [[1,2,4,5,6]],
  "ன": [[5,6]],
  "கா": [[1,3],[3,4,5]],
  "கி": [[1,3],[2,4]],
  "கீ": [[1,3],[3,5]],
  "கு": [[1,3],[1,3,6]],
  "கூ": [[1,3],[1,2,5,6]],
  "கெ": [[1,3],[2,6]],
  "கே": [[1,3],[1,5]],
  "கை": [[1,3],[3,4]],
  "கொ": [[1,3],[1,3,4,6]],
  "கோ": [[1,3],[1,3,5]],
  "கௌ": [[1,3],[2,4,6]],
  "ஙா": [[3,4,6],[3,4,5]],
  "ஙி": [[3,4,6],[2,4]],
  "ஙீ": [[3,4,6],[3,5]],
  "ங்கு": [[3,4,6],[1,3,6]],
  "ஙூ": [[3,4,6],[1,2,5,6]],
  "ஙெ": [[3,4,6],[2,6]],
  "ஙே": [[3,4,6],[1,5]],
  "ஙை": [[3,4,6],[3,4]],
  "ஙொ": [[3,4,6],[1,3,4,6]],
  "ஙோ": [[3,4,6],[1,3,5]],
  "ஙௌ": [[3,4,6],[2,4,6]],
  "சா": [[1,4],[3,4,5]],
  "சி": [[1,4],[2,4]],
  "சீ": [[1,4],[3,5]],
  "சு": [[1,4],[1,3,6]],
  "சூ": [[1,4],[1,2,5,6]],
  "செ": [[1,4],[2,6]],
  "சே": [[1,4],[1,5]],
  "சை": [[1,4],[3,4]],
  "சொ": [[1,4],[1,3,4,6]],
  "சோ": [[1,4],[1,3,5]],
  "சௌ": [[1,4],[2,4,6]],
  "ஞா": [[2,5],[3,4,5]],
  "ஞி": [[2,5],[2,4]],
  "ஞீ": [[2,5],[3,5]],
  "ஞு": [[2,5],[1,3,6]],
  "ஞூ": [[2,5],[1,2,5,6]],
  "ஞெ": [[2,5],[2,6]],
  "ஞே": [[2,5],[1,5]],
  "ஞை": [[2,5],[3,4]],
  "ஞொ": [[2,5],[1,3,4,6]],
  "ஞோ": [[2,5],[1,3,5]],
  "ஞௌ": [[2,5],[2,4,6]],
  "டா": [[2,3,4,5,6],[3,4,5]],
  "டி": [[2,3,4,5,6],[2,4]],
  "டீ": [[2,3,4,5,6],[3,5]],
  "டு": [[2,3,4,5,6],[1,3,6]],
  "டூ": [[2,3,4,5,6],[1,2,5,6]],
  "டெ": [[2,3,4,5,6],[2,6]],
  "டே": [[2,3,4,5,6],[1,5]],
  "டை": [[2,3,4,5,6],[3,4]],
  "டொ": [[2,3,4,5,6],[1,3,4,6]],
  "டோ": [[2,3,4,5,6],[1,3,5]],
  "டௌ": [[2,3,4,5,6],[2,4,6]],
  "ணா": [[3,4,5,6],[3,4,5]],
  "ணி": [[3,4,5,6],[2,4]],
  "ணீ": [[3,4,5,6],[3,5]],
  "ணு": [[3,4,5,6],[1,3,6]],
  "ணூ": [[3,4,5,6],[1,2,5,6]],
  "ணெ": [[3,4,5,6],[2,6]],
  "ணே": [[3,4,5,6],[1,5]],
  "ணை": [[3,4,5,6],[3,4]],
  "ணொ": [[3,4,5,6],[1,3,4,6]],
  "ணோ": [[3,4,5,6],[1,3,5]],
  "ணௌ": [[3,4,5,6],[2,4,6]],
  "தா": [[2,3,4,5],[3,4,5]],
  "தி": [[2,3,4,5],[2,4]],
  "தீ": [[2,3,4,5],[3,5]],
  "து": [[2,3,4,5],[1,3,6]],
  "தூ": [[2,3,4,5],[1,2,5,6]],
  "தெ": [[2,3,4,5],[2,6]],
  "தே": [[2,3,4,5],[1,5]],
  "தை": [[2,3,4,5],[3,4]],
  "தொ": [[2,3,4,5],[1,3,4,6]],
  "தோ": [[2,3,4,5],[1,3,5]],
  "தௌ": [[2,3,4,5],[2,4,6]],
  "நா": [[1,3,4,5],[3,4,5]],
  "நி": [[1,3,4,5],[2,4]],
  "நீ": [[1,3,4,5],[3,5]],
  "நு": [[1,3,4,5],[1,3,6]],
  "நூ": [[1,3,4,5],[1,2,5,6]],
  "நெ": [[1,3,4,5],[2,6]],
  "நே": [[1,3,4,5],[1,5]],
  "நை": [[1,3,4,5],[3,4]],
  "நொ": [[1,3,4,5],[1,3,4,6]],
  "நோ": [[1,3,4,5],[1,3,5]],
  "நௌ": [[1,3,4,5],[2,4,6]],
  "பா": [[1,2,3,4],[3,4,5]],
  "பி": [[1,2,3,4],[2,4]],
  "பீ": [[1,2,3,4],[3,5]],
  "பு": [[1,2,3,4],[1,3,6]],
  "பூ": [[1,2,3,4],[1,2,5,6]],
  "பெ": [[1,2,3,4],[2,6]],
  "பே": [[1,2,3,4],[1,5]],
  "பை": [[1,2,3,4],[3,4]],
  "பொ": [[1,2,3,4],[1,3,4,6]],
  "போ": [[1,2,3,4],[1,3,5]],
  "பௌ": [[1,2,3,4],[2,4,6]],
  "மா": [[1,3,4],[3,4,5]],
  "மி": [[1,3,4],[2,4]],
  "மீ": [[1,3,4],[3,5]],
  "மு": [[1,3,4],[1,3,6]],
  "மூ": [[1,3,4],[1,2,5,6]],
  "மெ": [[1,3,4],[2,6]],
  "மே": [[1,3,4],[1,5]],
  "மை": [[1,3,4],[3,4]],
  "மொ": [[1,3,4],[1,3,4,6]],
  "மோ": [[1,3,4],[1,3,5]],
  "மௌ": [[1,3,4],[2,4,6]],
  "யா": [[1,3,4,5,6],[3,4,5]],
  "யி": [[1,3,4,5,6],[2,4]],
  "யீ": [[1,3,4,5,6],[3,5]],
  "யு": [[1,3,4,5,6],[1,3,6]],
  "யூ": [[1,3,4,5,6],[1,2,5,6]],
  "யெ": [[1,3,4,5,6],[2,6]],
  "யே": [[1,3,4,5,6],[1,5]],
  "யை": [[1,3,4,5,6],[3,4]],
  "யொ": [[1,3,4,5,6],[1,3,4,6]],
  "யோ": [[1,3,4,5,6],[1,3,5]],
  "யௌ": [[1,3,4,5,6],[2,4,6]],
  "ரா": [[1,2,3,5],[3,4,5]],
  "ரி": [[1,2,3,5],[2,4]],
  "ரீ": [[1,2,3,5],[3,5]],
  "ரு": [[1,2,3,5],[1,3,6]],
  "ரூ": [[1,2,3,5],[1,2,5,6]],
  "ரெ": [[1,2,3,5],[2,6]],
  "ரே": [[1,2,3,5],[1,5]],
  "ரை": [[1,2,3,5],[3,4]],
  "ரொ": [[1,2,3,5],[1,3,4,6]],
  "ரோ": [[1,2,3,5],[1,3,5]],
  "ரௌ": [[1,2,3,5],[2,4,6]],
  "லா": [[1,2,3],[3,4,5]],
  "லி": [[1,2,3],[2,4]],
  "லீ": [[1,2,3],[3,5]],
  "லு": [[1,2,3],[1,3,6]],
  "லூ": [[1,2,3],[1,2,5,6]],
  "லெ": [[1,2,3],[2,6]],
  "லே": [[1,2,3],[1,5]],
  "லை": [[1,2,3],[3,4]],
  "லொ": [[1,2,3],[1,3,4,6]],
  "லோ": [[1,2,3],[1,3,5]],
  "லௌ": [[1,2,3],[2,4,6]],
  "வா": [[1,2,3,6],[3,4,5]],
  "வி": [[1,2,3,6],[2,4]],
  "வீ": [[1,2,3,6],[3,5]],
  "வு": [[1,2,3,6],[1,3,6]],
  "வூ": [[1,2,3,6],[1,2,5,6]],
  "வெ": [[1,2,3,6],[2,6]],
  "வே": [[1,2,3,6],[1,5]],
  "வை": [[1,2,3,6],[3,4]],
  "வொ": [[1,2,3,6],[1,3,4,6]],
  "வோ": [[1,2,3,6],[1,3,5]],
  "வௌ": [[1,2,3,6],[2,4,6]],
  "ழா": [[1,2,3,5,6],[3,4,5]],
  "ழி": [[1,2,3,5,6],[2,4]],
  "ழீ": [[1,2,3,5,6],[3,5]],
  "ழு": [[1,2,3,5,6],[1,3,6]],
  "ழூ": [[1,2,3,5,6],[1,2,5,6]],
  "ழெ": [[1,2,3,5,6],[2,6]],
  "ழே": [[1,2,3,5,6],[1,5]],
  "ழை": [[1,2,3,5,6],[3,4]],
  "ழொ": [[1,2,3,5,6],[1,3,4,6]],
  "ழோ": [[1,2,3,5,6],[1,3,5]],
  "ழௌ": [[1,2,3,5,6],[2,4,6]],
  "ளா": [[4,5,6],[3,4,5]],
  "ளி": [[4,5,6],[2,4]],
  "ளீ": [[4,5,6],[3,5]],
  "ளு": [[4,5,6],[1,3,6]],
  "ளூ": [[4,5,6],[1,2,5,6]],
  "ளெ": [[4,5,6],[2,6]],
  "ளே": [[4,5,6],[1,5]],
  "ளை": [[4,5,6],[3,4]],
  "ளொ": [[4,5,6],[1,3,4,6]],
  "ளோ": [[4,5,6],[1,3,5]],
  "ளௌ": [[4,5,6],[2,4,6]],
  "றா": [[1,2,4,5,6],[3,4,5]],
  "றி": [[1,2,4,5,6],[2,4]],
  "றீ": [[1,2,4,5,6],[3,5]],
  "று": [[1,2,4,5,6],[1,3,6]],
  "றூ": [[1,2,4,5,6],[1,2,5,6]],
  "றெ": [[1,2,4,5,6],[2,6]],
  "றே": [[1,2,4,5,6],[1,5]],
  "றை": [[1,2,4,5,6],[3,4]],
  "றொ": [[1,2,4,5,6],[1,3,4,6]],
  "றோ": [[1,2,4,5,6],[1,3,5]],
  "றௌ": [[1,2,4,5,6],[2,4,6]],
  "னா": [[5,6],[3,4,5]],
  "னி": [[5,6],[2,4]],
  "னீ": [[5,6],[3,5]],
  "னு": [[5,6],[1,3,6]],
  "னூ": [[5,6],[1,2,5,6]],
  "னெ": [[5,6],[2,6]],
  "னே": [[5,6],[1,5]],
  "னை": [[5,6],[3,4]],
  "னொ": [[5,6],[1,3,4,6]],
  "னோ": [[5,6],[1,3,5]],
  "னௌ": [[5,6],[2,4,6]],
  "க்": [[4],[1,3]],
  "ங்": [[4],[3,4,6]],
  "ச்": [[4],[1,4]],
  "ஞ்": [[4],[2,5]],
  "ட்": [[4],[2,3,4,5,6]],
  "ண்": [[4],[3,4,5,6]],
  "த்": [[4],[2,3,4,5]],
  "ந்": [[4],[1,3,4,5]],
  "ப்": [[4],[1,2,3,4]],
  "ம்": [[4],[1,3,4]],
  "ய்": [[4],[1,3,4,5,6]],
  "ர்": [[4],[1,2,3,5]],
  "ல்": [[4],[1,2,3]],
  "வ்": [[4],[1,2,3,6]],
  "ழ்": [[4],[1,2,3,5,6]],
  "ள்": [[4],[4,5,6]],
  "ற்": [[4],[1,2,4,5,6]],
  "ன்": [[4],[5,6]]
};

export interface BrailleCell {
  dots: number[];
  tamilChar: string;
  tamilIndex: number;
  mappingId?: string; // Unique ID to identify which mapping this cell belongs to
}

export interface ConversionResult {
  brailleCells: BrailleCell[][];
  tamilText: string;
  mappings: Array<{ tamilChar: string; brailleCells: BrailleCell[]; startIndex: number; endIndex: number; mappingId: string }>;
  wordBoundaries?: Array<{ startIndex: number; endIndex: number }>; // Track word boundaries
}

// Convert a single Braille cell representation to visual dots
function renderBrailleCell(dots: number[]): string {
  // Braille cell has 6 positions: 2 columns x 3 rows
  // Positions: 1(top-left), 2(middle-left), 3(bottom-left), 4(top-right), 5(middle-right), 6(bottom-right)
  const cell = [false, false, false, false, false, false];
  dots.forEach(pos => {
    if (pos >= 1 && pos <= 6) {
      cell[pos - 1] = true;
    }
  });
  
  // Convert to visual representation
  const topRow = `${cell[0] ? '●' : '○'} ${cell[3] ? '●' : '○'}`;
  const middleRow = `${cell[1] ? '●' : '○'} ${cell[4] ? '●' : '○'}`;
  const bottomRow = `${cell[2] ? '●' : '○'} ${cell[5] ? '●' : '○'}`;
  
  return `${topRow}\n${middleRow}\n${bottomRow}`;
}

// Convert Tamil text to Braille
export function convertTamilToBraille(text: string): ConversionResult {
  const mappings: Array<{ tamilChar: string; brailleCells: BrailleCell[]; startIndex: number; endIndex: number; mappingId: string }> = [];
  const brailleCells: BrailleCell[][] = [];
  const wordBoundaries: Array<{ startIndex: number; endIndex: number }> = [];
  
  let i = 0;
  let brailleRow: BrailleCell[] = [];
  let charIndex = 0;
  let mappingCounter = 0;
  let currentWordStart = 0;
  let inWord = false;
  
  while (i < text.length) {
    // Try to match longest possible sequence first (up to 4 characters for complex combinations)
    let matched = false;
    
    for (let len = Math.min(4, text.length - i); len >= 1; len--) {
      const char = text.slice(i, i + len);
      
      if (TAMIL_BRAILLE_MAP[char]) {
        // Start of a new word
        if (!inWord) {
          currentWordStart = charIndex;
          inWord = true;
        }
        
        const mappingId = `mapping-${mappingCounter++}`;
        const cells = TAMIL_BRAILLE_MAP[char].map(dots => ({
          dots,
          tamilChar: char,
          tamilIndex: charIndex,
          mappingId
        }));
        
        mappings.push({
          tamilChar: char,
          brailleCells: cells,
          startIndex: charIndex,
          endIndex: charIndex + char.length - 1,
          mappingId
        });
        
        brailleRow.push(...cells);
        i += len;
        charIndex += len;
        matched = true;
        break;
      }
    }
    
    if (!matched) {
      // Handle space or unrecognized character
      if (text[i] === ' ' || text[i] === '\n') {
        // End of word - mark the word boundary
        if (inWord) {
          wordBoundaries.push({
            startIndex: currentWordStart,
            endIndex: charIndex - 1
          });
          inWord = false;
        }
        
        if (text[i] === '\n' && brailleRow.length > 0) {
          brailleCells.push(brailleRow);
          brailleRow = [];
        }
        // Space doesn't create a Braille cell, but we mark it as word separator
      } else {
        // Unrecognized character - create empty cell or skip
      }
      i++;
      charIndex++;
    }
  }
  
  // Mark the last word if text doesn't end with space
  if (inWord) {
    wordBoundaries.push({
      startIndex: currentWordStart,
      endIndex: charIndex - 1
    });
  }
  
  if (brailleRow.length > 0) {
    brailleCells.push(brailleRow);
  }
  
  return {
    brailleCells,
    tamilText: text,
    mappings,
    wordBoundaries
  };
}

// Render Braille as visual text representation
export function renderBrailleAsText(cells: BrailleCell[][]): string {
  return cells.map(row => {
    return row.map(cell => {
      const cellArr = [false, false, false, false, false, false];
      cell.dots.forEach(pos => {
        if (pos >= 1 && pos <= 6) cellArr[pos - 1] = true;
      });
      // Simple text representation: use Unicode Braille characters or dots
      return cellArr.map((dot, idx) => {
        if (idx === 0 || idx === 3) return dot ? '⠿' : ' ';
        if (idx === 1 || idx === 4) return dot ? '●' : '○';
        if (idx === 2 || idx === 5) return dot ? '●' : '○';
        return ' ';
      }).join('');
    }).join('  '); // Two spaces between cells
  }).join('\n');
}

